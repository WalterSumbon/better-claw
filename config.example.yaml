# ============================================================================
# Better-Claw 配置文件
# ============================================================================
#
# 所有字段都有默认值，最小配置为空文件即可启动。
# 复制此文件到 <data-dir>/config.yaml 并根据需要修改。
#
# 配置优先级：CLI 参数 > 配置文件 > 默认值
# ============================================================================

# ----------------------------------------------------------------------------
# Anthropic API 配置
# ----------------------------------------------------------------------------
# agent-sdk 可复用 Claude CLI 的认证信息，通常不需要手动配置 apiKey。
# 仅在无法使用 CLI 认证或需要连接代理服务器时才需要配置。
anthropic:
  # API Key（可选）。
  # 如果已通过 `claude login` 登录 CLI，则无需配置。
  # apiKey: "sk-ant-your-api-key-here"

  # Auth Token（可选）。
  # 用于代理服务器认证，对应环境变量 ANTHROPIC_AUTH_TOKEN。
  # authToken: "your-auth-token-here"

  # Base URL（可选）。
  # 用于连接代理服务器或自定义 API 端点，对应环境变量 ANTHROPIC_BASE_URL。
  # baseUrl: "https://api.anthropic.com"

  # 默认模型 ID。
  # 可选值：claude-opus-4-6, claude-sonnet-4-6, claude-haiku-4-5-20251001 等。
  # 默认值："claude-opus-4-6"
  model: "claude-opus-4-6"

  # 单次查询最大预算（美元，可选）。
  # 超过此预算时查询会被终止。不设置则不限制。
  # maxBudgetUsd: 10.0

# ----------------------------------------------------------------------------
# Telegram 机器人配置（可选）
# ----------------------------------------------------------------------------
# 不配置此段则不启动 Telegram 适配器。
# telegram:
#   # Bot Token（必填）。从 Telegram @BotFather 获取。
#   botToken: "123456789:AABBccDDeeFFggHHiiJJkkLLmmNNooPPqqR"
#
#   # HTTP 代理地址（可选）。用于网络受限环境。
#   # proxy: "http://127.0.0.1:7890"
#
#   # 命令前缀（可选）。用于识别命令消息（如 /new、/stop）。
#   # 默认值："/"
#   # commandPrefix: "/"

# ----------------------------------------------------------------------------
# 钉钉机器人配置（可选）
# ----------------------------------------------------------------------------
# 不配置此段则不启动钉钉适配器。
# 需要在钉钉开放平台创建企业内部应用，启用机器人能力并选择 Stream 模式。
# dingtalk:
#   # AppKey / ClientID（必填）。从钉钉开放平台应用凭证页获取。
#   clientId: "your-app-key"
#
#   # AppSecret / ClientSecret（必填）。从钉钉开放平台应用凭证页获取。
#   clientSecret: "your-app-secret"
#
#   # robotCode（可选）。用于主动发消息 API，不填时默认使用 clientId。
#   # robotCode: "your-robot-code"
#
#   # 以下为企业定制版钉钉（如蚂蚁钉）的 API 地址配置，标准钉钉无需修改。
#   # apiBase: "https://api.dingtalk.com"
#   # oapiBase: "https://oapi.dingtalk.com"
#
#   # 命令前缀（可选）。用于识别命令消息（如 .new、.stop）。
#   # 钉钉会拦截 "/" 开头的消息，因此默认使用 "."。
#   # 默认值："."
#   # commandPrefix: "."

# ----------------------------------------------------------------------------
# 日志配置
# ----------------------------------------------------------------------------
logging:
  # 日志级别。
  # 可选值：trace, debug, info, warn, error, fatal
  # 默认值："info"
  level: "info"

  # 日志文件目录。相对路径基于 dataDir 解析。
  # 默认值："logs"
  directory: "logs"

  # 单个日志文件最大体积（pino-roll 格式：数字 + 单位）。
  # 单位：k（KB）、m（MB）、g（GB）。
  # 默认值："10m"
  maxSize: "10m"

  # 保留的日志轮转文件数量。超过后自动删除最旧的文件。
  # 默认值：10
  maxFiles: 10

  # Bot 回复日志的最大显示长度（字符数）。超过则在日志中显示为摘要。
  # 默认值：200
  replyLogMaxLength: 200

# ----------------------------------------------------------------------------
# 消息推送粒度配置
# ----------------------------------------------------------------------------
# 控制 agent 处理过程中向用户推送哪些中间信息。
messagePush:
  # 是否推送 assistant 中间文本消息（agent 思考过程中的阶段性回复）。
  # 启用后用户可以看到 agent 的中间思考结果，降低等待焦虑。
  # 默认值：true
  pushIntermediateMessages: true


# ----------------------------------------------------------------------------
# 数据目录路径
# ----------------------------------------------------------------------------
# 存放用户数据、会话记录、日志等所有运行时数据的根目录。
# CLI --data-dir 参数优先级更高。
# 默认值："data"
dataDir: "data"

# ----------------------------------------------------------------------------
# Agent 权限模式
# ----------------------------------------------------------------------------
# 控制 agent 执行文件操作和 shell 命令时的权限策略。
# 可选值：
#   - "default"：结合 permissions 配置进行路径级权限检查（推荐多用户环境）
#   - "acceptEdits"：自动允许文件编辑，shell 命令仍需确认
#   - "bypassPermissions"：跳过所有权限检查（最方便，适合私有部署）
# 默认值："default"
permissionMode: "default"

# ----------------------------------------------------------------------------
# 文件系统权限隔离配置
# ----------------------------------------------------------------------------
# 多用户环境下的文件系统访问控制。通过「权限组」和「工作组」两个维度隔离用户。
#
# ── 核心概念 ──
#
# 权限组（Permission Group）：
#   - 每个用户属于且仅属于一个权限组（通过 profile.permissionGroup 指定，或使用 defaultGroup）。
#   - 每组包含一个有序的规则列表（rules），从上到下依次匹配。
#   - 基础状态为"完全可读可写"（继承自 admin），规则逐条覆盖。
#   - 最后一条匹配的规则决定最终结果。
#   - 支持 inherits 继承另一个组的规则（默认继承 admin）。
#
# 工作组（Work Group）：
#   - 用于跨用户协作，共享一个 workspace 目录。
#   - 成员以 "rw"（读写）或 "r"（只读）权限加入。
#   - 一个用户可以同时属于多个工作组。
#
# ── 规则评估流程 ──
#
#   1. 从继承链的根（admin = 全部允许）开始。
#   2. 父组规则先生效，子组规则后生效（越具体的组越靠后，优先级越高）。
#   3. 工作组规则追加在最末尾。
#   4. 对于某次路径访问，从上到下扫描所有规则，最后命中的规则决定 allow / deny。
#
# ── 双层隔离 ──
#
#   1. canUseTool 回调 — 对 Read/Write/Edit/Glob/Grep 等内置工具做路径级检查。
#   2. Sandbox（OS 级）— 对 Bash 命令做进程级沙箱隔离。
#
permissions:
  # --------------------------------------------------------------------------
  # 权限组定义
  # --------------------------------------------------------------------------
  # 每个键是组名，值是该组的配置。
  #
  # 组配置字段：
  #   inherits: 继承的父组名（可选，默认 "admin"）。
  #   rules:    有序规则列表（可选，admin 组通常为空）。
  #
  # 单条规则字段：
  #   action: "allow" 或 "deny"
  #   access: "read"、"write" 或 "readwrite"
  #   path:   目标路径，支持以下变量（运行时自动替换为绝对路径）：
  #             ${userWorkspace} — 当前用户的 workspace（<dataDir>/users/<userId>/workspace/）
  #             ${userDir}       — 当前用户的数据目录（<dataDir>/users/<userId>/）
  #             ${dataDir}       — 全局数据目录（<dataDir>/）
  #           特殊值 "*" 匹配所有路径。
  #
  groups:
    # 管理员组：无规则 = 完全可读可写，所有权限组的默认继承源。
    admin: {}

    # 普通用户组：
    #   从 admin 继承（完全可读可写），然后逐条收紧：
    #   1. 禁止写入所有路径（全局只读，阻止全局安装、修改系统文件等）。
    #   2. 禁止整个数据目录的读写（隔离其他用户的数据、日志等）。
    #   3. 允许读取自己的用户目录（profile、memory 等）。
    #   4. 允许读写自己的 workspace（agent 工作区，包管理器局部安装在此进行）。
    user:
      # inherits: "admin"  # 可省略，默认就是 admin
      rules:
        - action: deny
          access: write
          path: "*"
        - action: deny
          access: readwrite
          path: "${dataDir}"
        - action: allow
          access: read
          path: "${userDir}"
        - action: allow
          access: readwrite
          path: "${userWorkspace}"

    # ── 自定义权限组示例 ──

    # 开发者组：继承 user 的所有规则，再额外开放 /opt/projects 的读写。
    # developer:
    #   inherits: "user"
    #   rules:
    #     - action: allow
    #       access: readwrite
    #       path: "/opt/projects"

    # 访客组：只能读自己的 workspace，不能写任何地方。
    # guest:
    #   rules:
    #     - action: deny
    #       access: readwrite
    #       path: "*"
    #     - action: allow
    #       access: read
    #       path: "${userWorkspace}"

  # --------------------------------------------------------------------------
  # 工作组定义（可选）
  # --------------------------------------------------------------------------
  # 每个工作组拥有一个共享 workspace：<dataDir>/workgroups/<groupName>/workspace/
  # 目录会在首次访问时自动创建。
  # 成员权限会作为额外的 allow 规则追加到规则链末尾。
  # 一个用户可以同时属于多个工作组。
  #
  # workGroups:
  #   team-alpha:
  #     members:
  #       user_abc123: "rw"    # 读写权限
  #       user_def456: "r"     # 只读权限
  #   team-beta:
  #     members:
  #       user_abc123: "r"
  #       user_ghi789: "rw"

  # --------------------------------------------------------------------------
  # 默认权限组
  # --------------------------------------------------------------------------
  # 用户 profile 中未指定 permissionGroup 时使用此组。
  # 默认值："user"
  defaultGroup: "user"

# ----------------------------------------------------------------------------
# 会话管理配置
# ----------------------------------------------------------------------------
# 控制对话会话的自动轮转策略和摘要生成行为。
# 当对话过长或间隔过久时，系统会自动归档当前会话并创建新会话，
# 同时生成摘要保留长期记忆。
session:
  # 时间间隔轮转阈值（小时）。
  # 用户最后一条消息距今超过此时间后，下次对话自动开启新会话。
  # 默认值：4
  rotationTimeoutHours: 4

  # Context 占比软轮转阈值（0-1）。
  # 当上下文 token 数占模型 context window 的比例达到此值时，
  # 在后台异步启动 summary 生成和会话浓缩，不阻塞当前消息处理。
  # 默认值：0.8
  rotationContextRatio: 0.8

  # Context 占比强制轮转阈值（0-1）。
  # 当上下文比例超过此值时，同步等待轮转完成后才处理下一条消息。
  # 必须大于 rotationContextRatio。
  # 默认值：0.9
  rotationForceRatio: 0.9

  # 轮转时是否生成 AI 摘要。
  # 启用后会在会话归档时自动生成对话摘要，用于后续会话的上下文衔接。
  # 默认值：true
  summaryEnabled: true

  # 摘要生成使用的模型。
  # 推荐使用较便宜的模型以降低成本，摘要任务不需要最强模型。
  # 默认值："claude-haiku-4-20250414"
  summaryModel: "claude-haiku-4-20250414"

  # system prompt 中展示的最近 session 数量（短期记忆）。
  # 更早的 session 会被浓缩合并到累积摘要中（长期记忆）。
  # 默认值：3
  maxRecentSessions: 3

# ----------------------------------------------------------------------------
# 重启权限配置
# ----------------------------------------------------------------------------
# 控制 agent 和用户分别是否可以触发服务重启。
restart:
  # 是否允许 agent（通过 MCP 工具）触发重启。
  # 设为 false 后 agent 将无法调用 restart 工具。
  # 默认值：true
  allowAgent: true

  # 是否允许用户（通过 /restart 命令）触发重启。
  # 设为 false 后所有用户的 /restart 命令都会被拒绝。
  # 默认值：true
  allowUser: true

  # 允许触发重启的用户 ID 白名单（仅在 allowUser 为 true 时生效）。
  # 为空数组时表示不限制，所有用户均可使用 /restart。
  # 填入用户 ID 后，仅白名单内的用户可以触发重启。
  # 默认值：[]（不限制）
  # userWhitelist:
  #   - "user_xxxxxxxx"

# ----------------------------------------------------------------------------
# 语音转文字配置（可选）
# ----------------------------------------------------------------------------
# 使用本地 OpenAI Whisper CLI 进行语音转录。
# 不配置此段时，语音消息仅保存音频文件，由 agent 自行决定如何处理
# （如通过外部 skill 或 MCP 工具转录）。
# 前置依赖：需安装 openai-whisper (pip install openai-whisper) 和 ffmpeg。
# speechToText:
#   # whisper 可执行文件路径。
#   # 如果已加入 PATH 则直接写 "whisper"，否则写完整路径。
#   # 默认值："whisper"
#   whisperPath: "whisper"
#
#   # whisper 模型名称。模型越大精度越高，但速度越慢、显存占用越大。
#   # 可选值：tiny, base, small, medium, large
#   # 默认值："base"
#   model: "base"
#
#   # 识别语言（可选）。不设置则自动检测语言。
#   # 常用值：zh（中文）, en（英文）, ja（日文）等。
#   # language: "zh"
